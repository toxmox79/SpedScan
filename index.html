<!DOCTYPE html>
<html lang="de">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Scanner für Speditionspakete mit Barcode-Verifizierung">
  <meta name="theme-color" content="#93c01f">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="SpedScan">
  <title>Speditions Scanner</title>
  <link rel="manifest" href="./manifest.json">
  <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
  <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
  <style>
    body {
      background-color: #f5f5f7;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
    }

    .container {
      max-width: 960px;
      margin: 0 auto;
      padding: 20px;
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
    }

    .error {
      background: #fee;
      color: #900;
      padding: 10px;
      border-radius: 8px;
      text-align: center;
      margin-bottom: 10px;
    }

    label {
      font-weight: bold;
      display: block;
      margin: 10px 0 5px;
    }

    input[type=file],
    .scan-input {
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }

    .scan-status {
      text-align: center;
      margin-top: 15px;
      font-size: 14px;
    }

    .scan-status .accent {
      color: #2a7a1f;
      font-weight: bold;
    }

    .table-container {
      background: white;
      border-radius: 8px;
      margin-top: 20px;
      overflow-x: auto;
      border: 1px solid #ccc;
      box-shadow: 0 2px 8px rgba(0, 0, 0, .08);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th,
    td {
      padding: 10px;
      border-bottom: 1px solid #ccc;
      text-align: left;
    }

    th {
      background: #f0f0f0;
    }

    tr.matched {
      background: #d4f7d4;
    }

    .no-data {
      text-align: center;
      padding: 20px;
    }

    .status-panel {
      background: #f1f3f5;
      border: 1px solid #d2d2d7;
      border-radius: 12px;
      padding: 16px;
      margin-top: 12px;
    }

    .file-input::file-selector-button {
      background-color: #93c01f;
      color: #fff;
      border: none;
      padding: 8px 16px;
      border-radius: 9999px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      margin-right: 12px;
    }

    .file-input::file-selector-button:hover {
      filter: brightness(0.95);
    }
  </style>
</head>

<body>
  <div id="root" class="container"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/papaparse@latest/papaparse.min.js"></script>
  <script>
    const { createRoot } = ReactDOM;
    const root = createRoot(document.getElementById('root'));

    const sounds = {
      positive: new Audio('sounds/positive.mp3'),
      negative: new Audio('sounds/negative.mp3'),
      confirm: new Audio('sounds/confirm.mp3'),
    };

    // Konfiguriere Audio-Objekte für bessere Android-Kompatibilität
    Object.values(sounds).forEach(a => {
      try {
        a.preload = 'auto';
        a.volume = 1.0;
        a.load();
      } catch (e) {
        console.warn('Audio preload error:', e);
      }
    });

    let audioUnlocked = false;
    let unlockAttempts = 0;

    function unlockAudioOnce() {
      if (audioUnlocked) return;
      unlockAttempts++;
      console.log('Attempting to unlock audio, attempt:', unlockAttempts);

      const unlockPromises = Object.values(sounds).map(a => {
        return new Promise((resolve) => {
          try {
            a.muted = true;
            a.volume = 0;
            const p = a.play();
            if (p && typeof p.then === 'function') {
              p.then(() => {
                a.pause();
                a.currentTime = 0;
                a.muted = false;
                a.volume = 1.0;
                console.log('Audio unlocked successfully');
                resolve(true);
              }).catch((err) => {
                console.warn('Audio unlock failed:', err);
                resolve(false);
              });
            } else {
              a.pause();
              a.currentTime = 0;
              a.muted = false;
              a.volume = 1.0;
              resolve(true);
            }
          } catch (e) {
            console.warn('Audio unlock exception:', e);
            resolve(false);
          }
        });
      });

      Promise.all(unlockPromises).then((results) => {
        if (results.some(r => r === true)) {
          audioUnlocked = true;
          console.log('Audio system unlocked');
        }
      });
    }

    function playSound(name) {
      const a = sounds[name];
      if (!a) return;

      try {
        a.currentTime = 0;
        a.volume = 1.0;
        const playPromise = a.play();

        if (playPromise && typeof playPromise.then === 'function') {
          playPromise.catch((error) => {
            console.warn('Audio play error for', name, ':', error);
            // Versuche Audio-Unlock erneut bei Fehler
            if (!audioUnlocked) {
              unlockAudioOnce();
            }
          });
        }
      } catch (e) {
        console.warn('Audio play exception for', name, ':', e);
      }
    }

    function toStringSafe(v) {
      if (v === null || v === undefined) return '';
      if (typeof v === 'number') return String(Math.trunc(v));
      return String(v).trim();
    }

    function normalizePackageNumber(packageNumber, fileName) {
      const pkgStr = toStringSafe(packageNumber);
      if (!fileName) return pkgStr;
      const isGeis = fileName.toLowerCase().includes('geis');
      if (isGeis && pkgStr.length > 3) {
        return pkgStr.slice(0, -3);
      }
      return pkgStr;
    }

    function App() {
      const [data, setData] = React.useState([]);
      const [currentScan, setCurrentScan] = React.useState(null);
      const [scanMode, setScanMode] = React.useState('package');
      const [matchedRows, setMatchedRows] = React.useState(new Set());
      const [error, setError] = React.useState(null);
      const [scanInput, setScanInput] = React.useState('');
      const [uploadedFileName, setUploadedFileName] = React.useState('');
      const inputRef = React.useRef(null);

      const handleFileUpload = (event) => {
        const file = event.target.files[0];
        if (file) {
          setUploadedFileName(file.name);
          Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            transformHeader: (header) => header.trim().replace(/^"|"$/g, ''),
            transform: (value) => (value ?? '').toString().trim().replace(/^"|"$/g, ''),
            complete: (results) => {
              const filteredData = results.data.filter(row => row['OrderItem.orderItemName'] !== 'Versandkosten');
              setData(filteredData);
            },
            error: (err) => {
              setError('Fehler beim Parsen der CSV-Datei: ' + err.message);
            },
          });
        }
      };

      const handleScanInput = (e) => {
        if (e.key === 'Enter' && scanInput) {
          handleScan(scanInput.trim());
          setScanInput('');
        } else {
          setScanInput(e.target.value);
        }
      };

      const handleScan = (scannedValue) => {
        setError(null);
        const code = toStringSafe(scannedValue);
        const normalizedScannedCode = normalizePackageNumber(code, uploadedFileName);

        if (scanMode === 'package') {
          const groupIndexes = data
            .map((row, idx) => ({ idx, row }))
            .filter(({ row }) => {
              const csvPackageNumber = toStringSafe(row['ShippingPackages.packageNumber']);
              return csvPackageNumber === normalizedScannedCode;
            })
            .map(({ idx }) => idx);

          if (groupIndexes.length === 0) {
            playSound('negative');
            setError('Paketnummer nicht gefunden!');
            setCurrentScan(null);
            setScanMode('package');
          } else {
            const items = groupIndexes.map(i => {
              const r = data[i];
              const qty = Math.max(1, parseInt(r['OrderItem.quantity'], 10) || 1);
              return {
                rowIndex: i,
                expectedBarcode: toStringSafe(r['VariationBarcode.code']),
                qtyRequired: qty,
                qtyRemaining: qty,
                name: `${r['DeliveryAddress.firstName']} ${r['DeliveryAddress.lastName']}`,
                itemName: r['OrderItem.orderItemName']
              };
            });

            const byBarcode = {};
            for (const it of items) {
              const key = it.expectedBarcode;
              if (!key) continue;
              byBarcode[key] = (byBarcode[key] || 0) + it.qtyRequired;
            }

            const totalRequired = items.reduce((s, it) => s + it.qtyRequired, 0);

            setCurrentScan({
              packageNumber: code,
              items,
              byBarcode,
              totalRequired,
              totalRemaining: totalRequired,
            });
            setScanMode('barcode');
            playSound('positive');
          }
        } else {
          if (!currentScan) return;
          const groups = { ...currentScan.byBarcode };
          const remainingForCode = groups[code] || 0;

          if (remainingForCode > 0) {
            groups[code] = remainingForCode - 1;

            const items = currentScan.items.map(it => {
              if (it.expectedBarcode === code && it.qtyRemaining > 0) {
                return { ...it, qtyRemaining: it.qtyRemaining - 1 };
              }
              return it;
            });

            const totalRemaining = currentScan.totalRemaining - 1;

            if (totalRemaining > 0) {
              setCurrentScan({ ...currentScan, byBarcode: groups, items, totalRemaining });
              playSound('positive');
            } else {
              const allIdx = items.map(it => it.rowIndex);
              setMatchedRows(prev => new Set([...prev, ...allIdx]));
              playSound('confirm');
              setCurrentScan(null);
              setScanMode('package');
            }
          } else {
            playSound('negative');
            setError('Falscher Barcode. Bitte erneut die Paketnummer scannen.');
            setCurrentScan(null);
            setScanMode('package');
          }
        }

        if (inputRef.current) inputRef.current.focus();
      };

      React.useEffect(() => { if (inputRef.current) inputRef.current.focus(); }, []);

      const renderTable = () => {
        if (data.length === 0) {
          return React.createElement('p', { className: 'no-data' }, 'Keine Daten hochgeladen.');
        }
        return React.createElement('div', { className: 'table-container' }, [
          React.createElement('table', null, [
            React.createElement('thead', null, [
              React.createElement('tr', null, [
                React.createElement('th', null, 'BESTELL-ID'),
                React.createElement('th', null, 'BARCODE'),
                React.createElement('th', null, 'PAKETNUMMER'),
                React.createElement('th', null, 'NAME'),
                React.createElement('th', null, 'ARTIKELNAME'),
                React.createElement('th', null, 'MENGE'),
              ]),
            ]),
            React.createElement('tbody', null, data.map((row, index) =>
              React.createElement('tr', { key: index, className: matchedRows.has(index) ? 'matched' : '' }, [
                React.createElement('td', null, row['Order.id']),
                React.createElement('td', null, toStringSafe(row['VariationBarcode.code'])),
                React.createElement('td', null, toStringSafe(row['ShippingPackages.packageNumber'])),
                React.createElement('td', null, `${row['DeliveryAddress.firstName']} ${row['DeliveryAddress.lastName']}`),
                React.createElement('td', null, row['OrderItem.orderItemName']),
                React.createElement('td', null, parseInt(row['OrderItem.quantity'], 10) || 1),
              ])
            ))
          ])
        ]);
      };

      const renderCurrentScan = () => {
        if (!currentScan) {
          return React.createElement('p', { className: 'scan-status' }, ['Scannen Sie eine ', React.createElement('span', { className: 'accent' }, 'Paketnummer')]);
        }
        const barcodeList = Object.entries(currentScan.byBarcode)
          .sort((a, b) => a[0].localeCompare(b[0]))
          .map(([ean, count]) => React.createElement('li', { key: ean }, `${ean || 'N/A'} – noch ${count}`));
        const itemLines = currentScan.items.map((it, idx) =>
          React.createElement('li', { key: idx }, `${it.itemName} (${it.expectedBarcode || 'N/A'}): ${it.qtyRequired - it.qtyRemaining}/${it.qtyRequired} gescannt`)
        );
        return React.createElement('div', { className: 'status-panel' }, [
          React.createElement('div', { className: 'scan-status' }, [
            React.createElement('p', null, ['Gescannte Paketnummer: ', React.createElement('span', { className: 'accent' }, currentScan.packageNumber)]),
            React.createElement('p', null, `Gesamt noch: ${currentScan.totalRemaining} von ${currentScan.totalRequired}`),
            React.createElement('p', null, 'Benötigte EANs:'),
            React.createElement('ul', null, barcodeList),
            React.createElement('p', null, 'Positionen:'),
            React.createElement('ul', null, itemLines),
            React.createElement('p', { className: 'mt-2' }, ['Bitte scannen Sie die ', React.createElement('span', { className: 'accent' }, 'zugehörigen EANs'), ' der Positionen.'])
          ])
        ]);
      };

      return React.createElement('div', null, [
        React.createElement('h1', null, 'Speditions Scanner'),
        error && React.createElement('div', { className: 'error' }, error),
        React.createElement('div', null, [React.createElement('label', null, 'CSV-Datei hochladen'), React.createElement('input', { type: 'file', accept: '.csv', onChange: handleFileUpload, className: 'file-input' })]),
        React.createElement('div', null, [React.createElement('label', null, uploadedFileName.toLowerCase().includes('geis') ? 'Geis Barcode scannen' : 'Barcode scannen'), React.createElement('input', { type: 'text', value: scanInput, onChange: (e) => setScanInput(e.target.value), onKeyDown: handleScanInput, ref: inputRef, placeholder: scanMode === 'package' ? 'Paketnummer scannen' : (uploadedFileName.toLowerCase().includes('geis') ? 'Geis Barcode scannen' : 'Barcode scannen'), className: 'scan-input' }), renderCurrentScan()]),
        renderTable()
      ]);
    }

    root.render(React.createElement(App));

    // Mehrere Event-Listener für verschiedene Geräte und Interaktionstypen
    window.addEventListener('touchstart', unlockAudioOnce, { once: true });
    window.addEventListener('touchend', unlockAudioOnce, { once: true });
    window.addEventListener('click', unlockAudioOnce, { once: true });
    window.addEventListener('pointerdown', unlockAudioOnce, { once: true });
    window.addEventListener('keydown', unlockAudioOnce, { once: true });

    // Zusätzlicher Unlock-Versuch beim ersten Input-Focus
    document.addEventListener('focusin', unlockAudioOnce, { once: true });

    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('Service Worker registered successfully:', registration.scope);
          })
          .catch(error => {
            console.log('Service Worker registration failed:', error);
          });
      });
    }
  </script>
</body>

</html>